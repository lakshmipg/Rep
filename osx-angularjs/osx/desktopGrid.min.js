$(function(){jQuery.DesktopGrid={dataObj:{},remake:function(options){if(jQuery.DesktopGrid.dataObj.making){jQuery.osxUtils.logger.info('desktop grid is making, so return...');return null;}
jQuery.osxUtils.logger.info('-------------------------- desktop grid --------------------------');jQuery.DesktopGrid.dataObj.making=true;for(var i=0;i<$.DesktopGrid.dataObj.totalScreens;i++){var screenId=$.DesktopGrid.dataObj.screenName+i;$('#'+screenId).remove();jQuery.osxUtils.logger.info('remake, delete screenId='+screenId);}
resetDataObj();var cellContentAry=make(options);setTimeout(function(){jQuery.DesktopGrid.dataObj.making=false;},500);return cellContentAry;},leftScreen:function(){if(jQuery.DesktopGrid.dataObj.currentScreen==0){jQuery.osxUtils.logger.info('current screen is first, do not need to switch screen');return;}
var totalScreen=jQuery.DesktopGrid.dataObj.totalScreens;var currentScreen=this.dataObj.currentScreen;jQuery.DesktopGrid.dataObj.currentScreen--;for(var i=0;i<totalScreen;i++){var $screen=$('#'+jQuery.DesktopGrid.dataObj.screenName+i);$screen.animate({left:$screen.position().left+jQuery.DesktopGrid.dataObj.gridWidth},'fast');}
highlightGridScreenThumbnail(jQuery.DesktopGrid.dataObj.currentScreen);jQuery.osxUtils.logger.info('totalScreen='+this.dataObj.totalScreens+', currentScreen='+currentScreen+', gotoScreen='+this.dataObj.currentScreen);},rightScreen:function(){if(jQuery.DesktopGrid.dataObj.currentScreen==jQuery.DesktopGrid.dataObj.totalScreens-1){jQuery.osxUtils.logger.info('current screen is last, do not need to switch screen');return;}
var totalScreen=jQuery.DesktopGrid.dataObj.totalScreens;var currentScreen=this.dataObj.currentScreen;jQuery.DesktopGrid.dataObj.currentScreen++;for(var i=0;i<totalScreen;i++){var $screen=$('#'+jQuery.DesktopGrid.dataObj.screenName+i);$screen.animate({left:$screen.position().left-jQuery.DesktopGrid.dataObj.gridWidth},'fast');}
highlightGridScreenThumbnail(jQuery.DesktopGrid.dataObj.currentScreen);jQuery.osxUtils.logger.info('totalScreen='+this.dataObj.totalScreens+', currentScreen='+currentScreen+', gotoScreen='+this.dataObj.currentScreen);},goToScreen:function(screen){if(screen==jQuery.DesktopGrid.dataObj.currentScreen){jQuery.osxUtils.logger.info('current screen is equal to screen you want to jump, so do not jump, currentScreen='+jQuery.DesktopGrid.dataObj.currentScreen+', gotoScreen='+screen);return;}
if(screen<0||screen>=jQuery.DesktopGrid.dataObj.totalScreens){jQuery.osxUtils.logger.info('screen must between 0 and '+(jQuery.DesktopGrid.dataObj.totalScreens-1));return;}
var totalScreen=jQuery.DesktopGrid.dataObj.totalScreens;var currentScreen=this.dataObj.currentScreen;var jumpDistance=(screen-currentScreen)*jQuery.DesktopGrid.dataObj.gridWidth;jQuery.DesktopGrid.dataObj.currentScreen=screen;for(var i=0;i<totalScreen;i++){var $screen=$('#'+jQuery.DesktopGrid.dataObj.screenName+i);$screen.animate({left:$screen.position().left-jumpDistance},'fast');}
highlightGridScreenThumbnail(screen);jQuery.osxUtils.logger.info('currentScreen='+currentScreen+', gotoScreen='+screen);},createGridScreenThumbnail:function(options){if(jQuery.DesktopGrid.dataObj.gridScreenThumbnail!=null){return jQuery.DesktopGrid.dataObj.gridScreenThumbnail;}
var $ul=$('<ul class="screenThumbnail"/>').css({'display':'block','background':'none'});var borderColor=jQuery.osxUtils.getRandomColor(50,50);for(var i=0;i<jQuery.DesktopGrid.dataObj.totalScreens;i++){var $li=$('<li/>');$li.css({'position':'relative','display':'block','float':'left','width':26,'min-width':26,'height':'100%','line-height':'auto','text-align':'center','cursor':'pointer','background':'none','border-left':i==0?'1px solid '+borderColor:'none','border-right':i<jQuery.DesktopGrid.dataObj.totalScreens-1?'1px solid '+borderColor:'none'}).attr({'_screen':i}).click(function(){var _screen=$(this).attr('_screen');if(_screen==jQuery.DesktopGrid.dataObj.currentScreen){return;}
highlightGridScreenThumbnail(_screen);jQuery.DesktopGrid.goToScreen(_screen);}).text(i);$li.appendTo($ul);}
jQuery.DesktopGrid.dataObj.gridScreenThumbnail=$ul;highlightGridScreenThumbnail(0);return $ul;}}
function highlightGridScreenThumbnail(toScreen){jQuery.DesktopGrid.dataObj.gridScreenThumbnail.find('li').css({background:'none'});jQuery.DesktopGrid.dataObj.gridScreenThumbnail.find('li').eq(toScreen).css({background:jQuery.osxUtils.getRandomColor(0,255)});}
function make(options){$.extend(jQuery.DesktopGrid.dataObj,options);var $gridDivOuter=$(jQuery.DesktopGrid.dataObj.gridDivOuterSelector);var $cellContent=$(jQuery.DesktopGrid.dataObj.gridCellSelector);jQuery.DesktopGrid.dataObj.totalCellContents=$cellContent.size();jQuery.osxUtils.logger.info('cellContentSize='+jQuery.DesktopGrid.dataObj.totalCellContents);if(jQuery.DesktopGrid.dataObj.totalCellContents==0){return;}
$('body').css({position:'relative',width:'100%',overflow:'hidden'});$gridDivOuter.css({position:'relative',overflow:'hidden'});var gridWidth=$gridDivOuter.width();var gridHeight=$gridDivOuter.height();jQuery.DesktopGrid.dataObj.gridWidth=gridWidth;jQuery.DesktopGrid.dataObj.cellContentMargin=(jQuery.DesktopGrid.dataObj.cellWrapWH-jQuery.DesktopGrid.dataObj.cellWH)/ 2;var rows=Math.floor((gridHeight-jQuery.DesktopGrid.dataObj.gridDivPaddingTop-jQuery.DesktopGrid.dataObj.gridDivPaddingBottom)/ jQuery.DesktopGrid.dataObj.cellWrapWH);var columns=Math.floor((gridWidth-jQuery.DesktopGrid.dataObj.gridDivPaddingLeft-jQuery.DesktopGrid.dataObj.gridDivPaddingRight)/ jQuery.DesktopGrid.dataObj.cellWrapWH);var totalCellsPerScreen=rows*columns;jQuery.DesktopGrid.dataObj.rows=rows;jQuery.DesktopGrid.dataObj.columns=columns;jQuery.DesktopGrid.dataObj.totalCellsPerScreen=totalCellsPerScreen;var cellContentAry=null;if(jQuery.DesktopGrid.dataObj.gridScreenSelector){cellContentAry=processScreenUserDefined($gridDivOuter);}else{cellContentAry=processScreenAuto($gridDivOuter,$cellContent);}
bindScreenEvent();return cellContentAry;}
function processScreenUserDefined($gridDivOuter){jQuery.osxUtils.logger.info('processScreenUserDefined...');var $gridScreen=$(jQuery.DesktopGrid.dataObj.gridScreenSelector);if($gridScreen.size()==0){jQuery.osxUtils.logger.info('can not find any grid screen by selector='+jQuery.DesktopGrid.dataObj.gridScreenSelector);return;}
jQuery.DesktopGrid.dataObj.totalScreens=$gridScreen.size();jQuery.osxUtils.logger.info('rows='+jQuery.DesktopGrid.dataObj.rows+', columns='+jQuery.DesktopGrid.dataObj.columns+', totalCellsPerScreen='+jQuery.DesktopGrid.dataObj.totalCellsPerScreen+', totalScreens='+jQuery.DesktopGrid.dataObj.totalScreens);initVirtualScreen($gridDivOuter);var cellContentAry=[];for(var i=0;i<$gridScreen.size();i++){cellContentAry[i]=[];var $screen=$($gridScreen[i]);var $cellContentPerScreen=$screen.find(jQuery.DesktopGrid.dataObj.gridCellSelector);for(var j=0;j<$cellContentPerScreen.size();j++){if(j>=jQuery.DesktopGrid.dataObj.totalCellsPerScreen){jQuery.osxUtils.logger.info('too many cellContent, so break, cellContents='+$cellContentPerScreen.size()+', totalCellsPerScreen='+jQuery.DesktopGrid.dataObj.totalCellsPerScreen);break;}
cellContentAry[i][j]=$($cellContentPerScreen[j]).clone(true,true);}}
processCellContent(cellContentAry);return cellContentAry;}
function processScreenAuto($gridDivOuter,$cellContent){jQuery.osxUtils.logger.info('processScreenAuto...');jQuery.DesktopGrid.dataObj.totalScreens=Math.ceil(jQuery.DesktopGrid.dataObj.totalCellContents / jQuery.DesktopGrid.dataObj.totalCellsPerScreen);jQuery.osxUtils.logger.info('rows='+jQuery.DesktopGrid.dataObj.rows+', columns='+jQuery.DesktopGrid.dataObj.columns+', totalCellsPerScreen='+jQuery.DesktopGrid.dataObj.totalCellsPerScreen+', totalCellContents='+jQuery.DesktopGrid.dataObj.totalCellContents+', totalScreens='+jQuery.DesktopGrid.dataObj.totalScreens);initVirtualScreen($gridDivOuter);var cellContentAry=splitCellByScreen($cellContent,jQuery.DesktopGrid.dataObj.totalCellsPerScreen,jQuery.DesktopGrid.dataObj.totalScreens);processCellContent(cellContentAry);return cellContentAry;}
function processCellContent(cellContentAry){for(var i=0;i<cellContentAry.length;i++){var $screen=$('#'+jQuery.DesktopGrid.dataObj.screenName+i);for(var j=0;j<cellContentAry[i].length;j++){var row=j%jQuery.DesktopGrid.dataObj.rows;var column=Math.floor(j / jQuery.DesktopGrid.dataObj.rows);var cellInfo=getCellAbs(row,column,jQuery.DesktopGrid.dataObj.cellWrapWH,jQuery.DesktopGrid.dataObj.cellContentMargin);cellInfo.cellWrapWH=jQuery.DesktopGrid.dataObj.cellWrapWH;cellInfo.cellWH=jQuery.DesktopGrid.dataObj.cellWH;cellInfo.cellContentMargin=jQuery.DesktopGrid.dataObj.cellContentMargin;cellInfo.row=row;cellInfo.column=column;cellInfo.screen=i;var $cell=$(cellContentAry[i][j]);decorateCell($cell,cellInfo);$cell.appendTo($screen);jQuery.DesktopGrid.dataObj.cellIdIJ[i+'_'+row+'_'+column]=$cell.attr('id');}}}
function resetDataObj(){jQuery.DesktopGrid.dataObj={gridWidth:0,cellIdIJ:{},rows:0,columns:0,totalCellsPerScreen:0,totalScreens:0,currentScreen:0,zIndex:1000*1,making:true,screenName:'jQueryDesktopScreen',cellContentMargin:0,totalCellContents:0,gridScreenThumbnail:null,gridDivOuterSelector:null,gridCellSelector:null,gridScreenSelector:null,cellWH:90,cellWrapWH:100,gridDivPaddingTop:0,gridDivPaddingBottom:0,gridDivPaddingLeft:0,gridDivPaddingRight:0,cellRandomBackgroundColor:true,screenRandomBackgroundColor:true,exchangeCellContent:true,easingManner:'swing',dragStartEvent:function(){},dragStopEvent:function(){}};}
function bindScreenEvent(){$(window).keydown(function(e){if(e.ctrlKey&&e.keyCode==37){jQuery.DesktopGrid.leftScreen();}
if(e.ctrlKey&&e.keyCode==39){jQuery.DesktopGrid.rightScreen();}});}
function splitCellByScreen($cellContent,totalCellsPerScreen,totalScreens){var screenCellAry=[];var length=$cellContent.length;out:for(var i=0;i<totalScreens;i++){screenCellAry[i]=[];for(var j=0;j<totalCellsPerScreen;j++){var tmp=i*totalCellsPerScreen+j;if(tmp>=length){break out;}
screenCellAry[i][j]=$($cellContent[i*totalCellsPerScreen+j]).clone(true,true);}}
return screenCellAry;}
function initVirtualScreen($gridDivOuter){for(var i=0;i<jQuery.DesktopGrid.dataObj.totalScreens;i++){var $screen=$('<div/>').attr({id:jQuery.DesktopGrid.dataObj.screenName+i}).css({overflow:'hidden',width:'100%',height:'100%',position:'absolute',top:0,left:0+jQuery.DesktopGrid.dataObj.gridWidth*i,background:jQuery.DesktopGrid.dataObj.screenRandomBackgroundColor==true?jQuery.osxUtils.getRandomColor():'none'}).appendTo($gridDivOuter);if(i==0){$screen.show();}
jQuery.osxUtils.logger.info('create grid screenId='+$screen.attr('id'));}
jQuery.DesktopGrid.dataObj.currentScreen=0;}
function decorateCell($this,cellInfo){$this.attr({_cell_wrap_wh:cellInfo.cellWrapWH,_cell_margin:cellInfo.cellContentMargin,_row:cellInfo.row,_column:cellInfo.column,_screen:cellInfo.screen,_top:cellInfo.top,_left:cellInfo.left}).css({cursor:'move','z-index':jQuery.DesktopGrid.dataObj.zIndex,position:'absolute',width:cellInfo.cellWH,height:cellInfo.cellWH,background:jQuery.DesktopGrid.dataObj.cellRandomBackgroundColor==true?jQuery.osxUtils.getRandomColor():'none',top:cellInfo.top,left:cellInfo.left}).show();function getStartEventKey(eventType){if($.parser){if(eventType=='start'){return'onStartDrag';}else if(eventType=='stop'){return'onStopDrag';}}
if(eventType=='start'){return'start';}else if(eventType=='stop'){return'stop';}}
var dragEventConfig={};dragEventConfig[getStartEventKey('start')]=function(){jQuery.osxUtils.logger.info('onStartDrag...');var $this=$(this);$this.css('z-index',++jQuery.DesktopGrid.dataObj.zIndex);jQuery.DesktopGrid.dataObj.dragStartEvent();}
dragEventConfig[getStartEventKey('stop')]=function(){jQuery.osxUtils.logger.info('onStopDrag...');rePositionCell($(this));jQuery.DesktopGrid.dataObj.dragStopEvent();}
$this.draggable(dragEventConfig);}
function getCellWrapperAbs(row,column,wrapCellWH){return{top:wrapCellWH*row,left:wrapCellWH*column}}
function getCellAbs(row,column,wrapCellWH,cellMargin){return{top:wrapCellWH*row+cellMargin+jQuery.DesktopGrid.dataObj.gridDivPaddingTop,left:wrapCellWH*column+cellMargin+jQuery.DesktopGrid.dataObj.gridDivPaddingLeft}}
function getCellAbsCenter(row,column,wrapCellWH){return{top:wrapCellWH*row+wrapCellWH / 2,left:wrapCellWH*column+wrapCellWH / 2}}
function rePositionCell($this){var top=parseInt($this.position().top);var left=parseInt($this.position().left);var width=parseInt($this.width());var height=parseInt($this.height());var cellWrapWH=parseInt($this.attr('_cell_wrap_wh'));var cellMargin=parseInt($this.attr('_cell_margin'));var rowSrcFrom=parseInt($this.attr('_row'));var columnSrcFrom=parseInt($this.attr('_column'));var topSrc=$this.attr('_top');var leftSrc=$this.attr('_left');var centerTop=top+height / 2;var centerLeft=left+width / 2;var rowNew=Math.floor((centerTop-jQuery.DesktopGrid.dataObj.gridDivPaddingTop)/ cellWrapWH);var columnNew=Math.floor((centerLeft-jQuery.DesktopGrid.dataObj.gridDivPaddingLeft)/ cellWrapWH);jQuery.osxUtils.logger.info('rowSrc='+rowSrcFrom+', columnSrc='+columnSrcFrom)
jQuery.osxUtils.logger.info('rowNew='+rowNew+', columnNew='+columnNew);rowNew=Math.max(rowNew,0);columnNew=Math.max(columnNew,0);rowNew=Math.min(rowNew,jQuery.DesktopGrid.dataObj.rows-1);columnNew=Math.min(columnNew,jQuery.DesktopGrid.dataObj.columns-1);var cellAbsDragFrom=getCellAbs(rowSrcFrom,columnSrcFrom,cellWrapWH,cellMargin);var cellAbsDragTo=getCellAbs(rowNew,columnNew,cellWrapWH,cellMargin);if(rowSrcFrom==rowNew&&columnSrcFrom==columnNew){jQuery.osxUtils.logger.log('position, row='+rowNew+', column='+columnNew+' is the src position, do not need move');moveCellTo(jQuery.DesktopGrid.dataObj.currentScreen,$this,cellAbsDragFrom,rowSrcFrom,columnSrcFrom,rowSrcFrom,columnSrcFrom,false);return;}
var cellIdDragTo=jQuery.DesktopGrid.dataObj.cellIdIJ[jQuery.DesktopGrid.dataObj.currentScreen+'_'+rowNew+'_'+columnNew];var $cellDragTo=$('#'+cellIdDragTo);if($cellDragTo.size()==0){moveCellTo(jQuery.DesktopGrid.dataObj.currentScreen,$this,cellAbsDragTo,rowSrcFrom,columnSrcFrom,rowNew,columnNew,true);}else{if(jQuery.DesktopGrid.dataObj.exchangeCellContent){jQuery.osxUtils.logger.log('position, row='+rowNew+', column='+columnNew+' is already occupied, exchange two cells content');moveCellTo(jQuery.DesktopGrid.dataObj.currentScreen,$this,cellAbsDragTo,rowSrcFrom,columnSrcFrom,rowNew,columnNew,false);moveCellTo(jQuery.DesktopGrid.dataObj.currentScreen,$cellDragTo,cellAbsDragFrom,rowNew,columnNew,rowSrcFrom,columnSrcFrom,false);}else{jQuery.osxUtils.logger.log('position, row='+rowNew+', column='+columnNew+' is already occupied, please change other position');moveCellTo(jQuery.DesktopGrid.dataObj.currentScreen,$this,cellAbsDragFrom,rowSrcFrom,columnSrcFrom,rowSrcFrom,columnSrcFrom,false);}}}
function moveCellTo(screen,$cell,cellAbs,rowSrc,columnSrc,rowNew,columnNew,setSrc){$cell.attr({_row:rowNew,_column:columnNew,_top:cellAbs.top,_left:cellAbs.left}).css({'z-index':++jQuery.DesktopGrid.dataObj.zIndex}).animate({top:cellAbs.top,left:cellAbs.left},300,$.DesktopGrid.dataObj.easingManner);if(setSrc)jQuery.DesktopGrid.dataObj.cellIdIJ[screen+'_'+rowSrc+'_'+columnSrc]=null;jQuery.DesktopGrid.dataObj.cellIdIJ[screen+'_'+rowNew+'_'+columnNew]=$cell.attr('id');}})